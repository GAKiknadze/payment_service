# QuotaAppService

Управление квотами и лимитами. Доступ для пользователей и администраторов.

### CheckQuotaUsage
**Назначение**: Проверка возможности использования ресурса перед выполнением операции.
**Доступ**: Все пользователи (через API-вызовы системы).

**Предусловия**:
- Организация должна существовать и быть активной.
- Должна существовать активная подписка, включающая запрашиваемый ресурс.
- Пользователь должен иметь права на использование ресурса в организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `resourceType`: Тип ресурса.
- `usageIncrement`: Запрашиваемое увеличение (например, 1 токен).
- `checkOnly` (опционально): Только проверить без резервирования (по умолчанию true).

**Условия выполнения**:
- Для ресурсов с квотами: `CurrentQuotaUsage + usageIncrement <= Quota.Limit`.
- Для разовых ресурсов (например, SSL): `usageIncrement <= RemainingQuota`.
- Для ресурсов с предоплатой: баланс организации ≥ стоимости операции.

**Выходные данные**:
- `isAllowed`: Разрешено ли использование (`true/false`).
- `remainingQuota`: Оставшийся лимит.
- `reason` (опционально): Причина отказа (например, "QuotaExceeded", "InsufficientFunds").
- `costEstimate` (опционально): Расчетная стоимость операции (для ресурсов с предоплатой).

**Возможные ошибки**:
- `QuotaExceededException`: Превышение лимита квоты.
- `ResourceNotSubscribedException`: Организация не подключила этот ресурс.
- `OrganizationSuspendedException`: Организация приостановлена.
- `InsufficientFundsException`: Недостаточно средств для выполнения операции.

---

### IncrementUsage
**Назначение**: Увеличение использования квоты при выполнении операции.
**Доступ**: Системные процессы (автоматически при использовании ресурса).

**Предусловия**:
- Должна существовать активная подписка с этим ресурсом.
- Проверка квоты уже пройдена (через CheckQuotaUsage).
- `increment > 0`.
- Организация должна быть в статусе Active.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `resourceType`: Тип ресурса.
- `increment`: Значение для увеличения.
- `operationId` (опционально): Идентификатор операции для отслеживания.

**Условия выполнения**:
- Операция должна соответствовать типу ресурса.
- Для периодических квот проверяется, что не выходим за пределы текущего периода.
- Для разовых ресурсов проверяется наличие достаточного количества.

**Постусловия**:
- Обновление `CurrentQuotaUsage` в агрегате `Subscription`.
- Создание записи в истории использования квот.
- При достижении определенного порога отправка уведомления.

**Возможные ошибки**:
- `InvalidIncrementException`: Отрицательное или нулевое значение.
- `QuotaExceededException`: Превышение лимита (даже после предварительной проверки).
- `SubscriptionNotFoundException`: Подписка не найдена или неактивна.
- `ResourceTypeNotSupportedException`: Неподдерживаемый тип ресурса.

**Выходные данные**:
- `newUsage`: Обновленное значение использования квоты.
- `remainingQuota`: Оставшийся лимит после операции.
- `quotaStatus`: Статус квоты (Normal, Warning, Exceeded).
- `resetIn`: Время до сброса квоты (для периодических тарифов).