# BillingAppService

Фоновые процессы и ручное управление.

### ProcessScheduledBilling
**Назначение**: Запуск фонового процесса списания средств по расписанию.
**Доступ**: Администратор (ручной запуск) или система (автоматически).
**Предусловия**:
- Пользователь должен иметь права администратора (для ручного запуска).
- Система должна быть в рабочем состоянии (для автоматического запуска).

**Входные параметры**:
- `currentDateTime` (опционально): Дата и время для тестирования (по умолчанию - текущее).

**Условия выполнения**:
- Обрабатываются только подписки с `NextBillingDate <= currentDateTime`.
- Для `OneTime` тарифов подписка переводится в статус `Cancelled` после успешного списания.
- Платежи обрабатываются последовательно, одна подписка за раз.

**Постусловия**:
- Автоматическое срабатывание `CheckAutoTopUp` при недостатке средств.
- Обновление `NextBillingDate` для периодических тарифов (на основании `BillingCycle`).
- Создание записи в истории платежей для каждой обработанной подписки.
- При отсутствии средств подписка переводится в статус `Suspended`.

**Возможные ошибки**:
- `InsufficientFundsException`: Недостаточно средств для списания.
- `PaymentMethodExpiredException`: Платежный метод просрочен.
- `SubscriptionNotFoundException`: Подписка не найдена или недоступна.

**Выходные данные**:
- `processedSubscriptions`: Количество обработанных подписок.
- `successfulPayments`: Количество успешных списаний.
- `failedPayments`: Список подписок с ошибками (например, `[{ subscriptionId: 123, error: "InsufficientFunds" }]`).
- `suspendedSubscriptions`: Количество приостановленных подписок из-за недостатка средств.

---

### TriggerAutoTopUp
**Назначение**: Принудительный запуск автопополнения для тестирования или ручного срабатывания.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Организация должна существовать и быть активной.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `force` (опционально): Игнорировать проверку порога (по умолчанию `false`).

**Условия выполнения**:
- Автопополнение должно быть включено для организации (`AutoTopUpSettings.IsEnabled = true`).
- При `force = false` проверяется, что `balance < AutoTopUpSettings.Threshold`.
- Платежный метод для автопополнения должен быть действителен.

**Постусловия**:
- Создание платежа типа `TopUp` с суммой `AutoTopUpSettings.TopUpAmount`.
- Обновление баланса при успешном платеже.
- При неудачном платеже сохраняется попытка в истории для последующего анализа.

**Возможные ошибки**:
- `AutoTopUpDisabledException`: Автопополнение выключено для организации.
- `BalanceAboveThresholdException`: Баланс выше порога (без флага `force`).
- `PaymentMethodInvalidException`: Платежный метод недействителен или отсутствует.
- `OrganizationNotFoundException`: Организация не найдена.

**Выходные данные**:
- `topUpResult`: Результат (`Success`, `PaymentFailed`, `Skipped`).
- `newBalance`: Обновленный баланс (при успехе).
- `transactionId`: Идентификатор транзакции (при успехе).
- `attemptCount`: Количество попыток автопополнения (для отслеживания повторных неудач).

---

### GetPaymentHistory
**Назначение**: Получение истории платежей с возможностью фильтрации.
**Доступ**:
- `Пользователь`: Только свои платежи.
- `Администратор`: Все платежи с фильтрами.

**Предусловия**:
- Для пользователя: платежи должны принадлежать его организации.
- Для администратора: организация должна существовать (если указан `organizationId`).

**Входные параметры**:
- `organizationId` (опционально): Фильтр по организации.
- `startDate`, `endDate` (опционально): Период (проверяется, что `endDate` > `startDate`).
- `type` (опционально): Тип платежа (`Subscription`, `TopUp`, `Refund`, `ManualCharge`).
- `status` (опционально): Статус платежа (`Completed`, `Failed`, `Pending`).
- `pageSize` (опционально): Количество записей на странице (по умолчанию 20).
- `pageNumber` (опционально): Номер страницы (по умолчанию 1).

**Условия выполнения**:
- Максимальный период фильтрации - 2 года.
- Для пользователя без указания `organizationId` используются платежи его организации.

**Выходные данные**:
- `payments`: Массив платежей с полями:
  - `id`, `amount`, `currency`
  - `type`, `status`, `timestamp`
  - `subscriptionId` (для подписок)
  - `relatedEntityId` (дополнительные сущности)
- `totalItems`: Общее количество записей (для пагинации)
- `currentPage`, `totalPages`: Информация о пагинации

**Возможные ошибки**:
- `InvalidDateRangeException`: Некорректный период (startDate > endDate или период > 2 лет).
- `AccessDeniedException`: Попытка доступа к чужим платежам.

---

### GenerateBillingReport
**Назначение**: Генерация отчета по платежам за период.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Период должен быть корректным (endDate > startDate).

**Входные параметры**:
- `startDate`, `endDate`: Период отчета.
- `format`: Формат (`PDF`, `CSV`, `Excel`).
- `organizationId` (опционально): Фильтр по конкретной организации.

**Условия выполнения**:
- `endDate` > `startDate`.
- Максимальный период — 1 год.
- Для `organizationId` проверяется существование организации.

**Постусловия**:
- Создание временного файла отчета.
- Сохранение метаданных отчета в системе.

**Возможные ошибки**:
- `InvalidDateRangeException`: Некорректный период (более 1 года).
- `InvalidFormatException`: Неподдерживаемый формат.
- `OrganizationNotFoundException`: Указанная организация не существует.

**Выходные данные**:
- `reportUrl`: Ссылка на сгенерированный отчет (действительна 24 часа).
- `summary`: Итоговые данные (общая выручка, количество транзакций, количество организаций).
- `generationTime`: Время генерации отчета.
- `expiresAt`: Время окончания действия ссылки.

---

### ManualCharge
**Назначение**: Ручное списание средств за разовое использование ресурса.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Существует активная подписка, включающая запрашиваемый ресурс.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `resourceType`: Тип ресурса (например, `ssl_certificate`).
- `quantity`: Количество (для ресурсов с квотами).
- `description` (опционально): Описание операции.

**Условия выполнения**:
- Ресурс должен быть в списке `Quotas` активных подписок.
- Баланс организации ≥ стоимости операции (рассчитанной как `quantity * resourcePrice`).
- Для OneTime ресурсов `quantity` обычно = 1.

**Постусловия**:
- Списание средств через `Organization.AdjustBalance(-cost)`.
- Обновление `CurrentQuotaUsage` для ресурса.
- Создание записи в истории платежей типа `ManualCharge`.

**Возможные ошибки**:
- `QuotaExceededException`: Превышение лимита квоты (если ресурс квотируемый).
- `ResourceNotSubscribedException`: Организация не подключила этот ресурс.
- `InsufficientFundsException`: Недостаточно средств на балансе.
- `ResourceTypeNotSupportedException`: Неподдерживаемый тип ресурса.

**Выходные данные**:
- `chargedAmount`: Сумма списания.
- `newBalance`: Обновленный баланс организации.
- `newQuotaUsage`: Обновленное использование квоты (если применимо).
- `transactionId`: Идентификатор транзакции.

---

### RetryFailedPayment
**Назначение**: Повторная попытка списания для неудачного платежа.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Платеж должен существовать и принадлежать системе.

**Входные параметры**:
- `paymentId`: Идентификатор платежа.
- `maxRetries` (опционально): Максимальное количество попыток (по умолчанию 3).

**Условия выполнения**:
- Платеж должен быть в статусе `Failed`.
- Должен быть доступен платежный метод.
- Количество предыдущих попыток < `maxRetries`.

**Постусловия**:
- Повтор вызова платежного шлюза с использованием сохраненного платежного метода.
- Обновление статуса платежа и счетчика попыток.
- При достижении лимита попыток подписка переводится в статус `Suspended`.

**Возможные ошибки**:
- `PaymentAlreadyRetriedException`: Достигнут лимит попыток.
- `PaymentMethodExpiredException`: Платежный метод недействителен.
- `PaymentNotFoundException`: Платеж не найден или недоступен.
- `InvalidPaymentStatusException`: Платеж не в статусе Failed.

**Выходные данные**:
- `newStatus`: Новый статус платежа (`Completed`, `Failed`, `Suspended`).
- `retryCount`: Текущее количество попыток.
- `transactionId`: Идентификатор новой транзакции (при успехе).
- `nextRetryAt`: Рекомендуемое время следующей попытки (при частичном успехе).