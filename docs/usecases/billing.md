# BillingAppService

Фоновые процессы и ручное управление.

---

## ProcessScheduledBilling
**Назначение**: Запуск фонового процесса списания средств по расписанию.

**Доступ**: Администратор (ручной запуск) или система (автоматически).

**Входные параметры**:

- `currentDateTime` (опционально): Дата и время для тестирования (по умолчанию - текущее).

**Условия выполнения**:

- Обрабатываются только подписки с `NextBillingDate <= currentDateTime`.
- Для `OneTime` тарифов подписка переводится в статус `Cancelled` после списания.

**Постусловия**:

- Автоматическое срабатывание `CheckAutoTopUp` при недостатке средств.
- Обновление `NextBillingDate` для периодических тарифов.

**Выходные данные**:

- `processedSubscriptions`: Количество обработанных подписок.
- `failedPayments`: Список подписок с ошибками (например, `[{ subscriptionId: 123, error: "InsufficientFunds" }]`).

---

## TriggerAutoTopUp
**Назначение**: Принудительный запуск автопополнения для тестирования.

**Доступ**: Только администратор.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `force` (опционально): Игнорировать проверку порога (по умолчанию `false`).

**Условия выполнения**:

- Автопополнение должно быть включено для организации.
- При `force = false` проверяется, что `balance < threshold`.

**Постусловия**:

- Создание платежа типа `TopUp`.
- Обновление баланса при успехе.

**Возможные ошибки**:

- `AutoTopUpDisabledException`: Автопополнение выключено.
- `BalanceAboveThresholdException`: Баланс выше порога (без флага `force`).

**Выходные данные**:

- `topUpResult`: Результат (`Success`, `PaymentFailed`, `Skipped`).
- `newBalance`: Обновленный баланс (при успехе).

---

## GetPaymentHistory
**Назначение**: Получение истории платежей.

**Доступ**:

- `Пользователь`: Только свои платежи.
- `Администратор`: Все платежи с фильтрами.

**Входные параметры**:

- `organizationId` (опционально): Фильтр по организации.
- `startDate`, `endDate` (опционально): Период.
- `type` (опционально): Тип платежа (`Subscription`, `TopUp`, `Refund`).

**Выходные данные**:

- `payments`: Массив платежей с полями:
    - `id`, `amount`, `currency`.
    - `type`, `status`, `timestamp`.
    - `subscriptionId` (для подписок).

---

## GenerateBillingReport
**Назначение**: Генерация отчета по платежам за период.

**Доступ**: Только администратор.

**Входные параметры**:

- `startDate`, `endDate`: Период отчета.
- `format`: Формат (`PDF`, `CSV`).

**Условия выполнения**:

- `endDate` > `startDate`.
- Максимальный период — 1 год.

**Выходные данные**:

- `reportUrl`: Ссылка на сгенерированный отчет.
- `summary`: Итоговые данные (общая выручка, количество транзакций).

---

## ManualCharge
**Назначение**: Ручное списание средств за разовое использование ресурса.

**Доступ**: Только администратор.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `resourceType`: Тип ресурса (например, `ssl_certificate`).
- `quantity`: Количество (для ресурсов с квотами).

**Условия выполнения**:

- Ресурс должен быть в списке `Quotas` активных подписок.
- Баланс организации ≥ стоимости операции.

**Постусловия**:

- Списание средств через O`rganization.AdjustBalance(-cost)`.
- Обновление `CurrentQuotaUsage` для ресурса.

**Возможные ошибки**:

- `QuotaExceededException`: Превышение лимита квоты.
- `ResourceNotSubscribedException`: Организация не подключила этот ресурс.

**Выходные данные**:

- `chargedAmount`: Сумма списания.
- `newQuotaUsage`: Обновленное использование квоты.

---

## RetryFailedPayment

**Назначение**: Повторная попытка списания для неудачного платежа.

**Доступ**: Только администратор.

**Входные параметры**:

- `paymentId`: Идентификатор платежа.

**Условия выполнения**:

- Платеж должен быть в статусе `Failed`.
- Должен быть доступен платежный метод.

**Постусловия**:

- Повтор вызова платежного шлюза.
- Обновление статуса платежа.

**Возможные ошибки**:

- `PaymentAlreadyRetriedException`: Платеж уже был повторен.
- `PaymentMethodExpiredException`: Платежный метод недействителен.

**Выходные данные**:

- `newStatus`: Новый статус платежа (`Completed`, `Failed`).
- `retryCount`: Количество попыток.
