# OrganizationAppService

Управление организациями.

**Разделение прав**:
- `Пользователь` (владелец организации): Создание, просмотр, обновление настроек своей организации.
- `Администратор`: Полный контроль над всеми организациями, включая принудительное удаление и диагностику.

---

## CreateOrganization
**Назначение**: Создание новой организации с фиксированной валютой.

**Доступ**: Только пользователь (владелец).

**Входные параметры**:

- `name`: Название организации (обязательный, строка, 3–100 символов).
- `currencyCode`: Код валюты (обязательный, например, RUB, USD; должен быть в списке поддерживаемых системой).

**Условия выполнения**:

- Пользователь не имеет активных организаций (ограничение: 1 организация на владельца).
- Валюта должна быть в списке SupportedCurrencies (проверяется через Currency.IsValidCode()).
- Владелец должен иметь подтвержденный аккаунт.

**Предусловия**:

- Проверка уникальности названия организации через IOrganizationRepository.CheckNameUniqueness(name).
- Проверка поддержки валюты: CurrencyService.IsSupported(currencyCode).

**Постусловия**:

- Создание агрегата Organization с:
    - Balance = 0.
    - AutoTopUpSettings = { IsEnabled: false, Threshold: 0, TopUpAmount: 0 }.
    - Status = Active.
- Привязка организации к владельцу (идентификатор пользователя).

**Возможные ошибки**:

- `OrganizationLimitExceededException`: Владелец уже имеет активную организацию.
- `UnsupportedCurrencyException`: Указана невалидная валюта.
- `NameAlreadyExistsException`: Название занято.

**Выходные данные**:

- `organizationId`: Уникальный идентификатор созданной организации.
- `currency`: Валюта организации (например, RUB).
- `autoTopUpSettings`: Настройки автопополнения по умолчанию.

---

## GetOrganization

**Назначение**: Получение данных об организации.

**Доступ**:

- `Пользователь`: Только своя организация.
- `Администратор`: Любая организация по organizationId.

**Входные параметры**:

- `organizationId`: Идентификатор организации (обязательный).

**Условия выполнения**:

- `Для пользователя`: organizationId должен принадлежать владельцу.
- `Для администратора`: организация должна существовать.

**Выходные данные**:

- `name`: Название.
- `currency`: Валюта.
- `balance`: Текущий баланс (в валюте организации).
- `autoTopUpSettings`: Настройки автопополнения.
- `subscriptions`: Список активных подписок (только для владельца).
- `status`: Статус организации (Active, Suspended, Deleted).

**Возможные ошибки**:

- `OrganizationNotFoundException`: Организация не найдена или недоступна.
- `AccessDeniedException`: Попытка доступа к чужой организации.

---

## UpdateOrganization
**Назначение**: Обновление данных организации.

**Доступ**:

- `Пользователь`: Только название (name).
- `Администратор`: Все поля, кроме currency (валюта неизменна).

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `name` (опционально): Новое название.
- `status` (только для администратора): Новый статус (Suspended, Active).

**Условия выполнения**:

- `Для пользователя`: нельзя менять currency, balance, status.
- `Для администратора`:
    - При переводе в статус Suspended все активные подписки приостанавливаются.
    - Баланс можно изменить только через AdjustBalance (отдельный метод для админов).

**Предусловия**:

- Проверка уникальности названия (если обновляется `name`).

**Возможные ошибки**:

- `InvalidStatusTransitionException`: Нельзя перевести организацию в статус Deleted напрямую (требуется DeleteOrganization).
- `CurrencyModificationException`: Попытка изменить валюту.

**Выходные данные**:

- `updatedFields`: Список обновленных полей (например, ["name"]).

---

## DeleteOrganization
**Назначение**: Удаление организации.

**Доступ**:

- `Пользователь`: Только своя организация, если нет активных подписок или долгов.
- `Администратор`: Принудительное удаление (все подписки отменяются, баланс обнуляется).

**Входные параметры**:

`organizationId`: Идентификатор организации.
`force` (только для администратора): Флаг принудительного удаления.

**Условия выполнения**:

- `Для пользователя`:
    - Все подписки должны быть отменены (status = Cancelled).
    - Баланс = 0.
- `Для администратора`:
    - При force = true:
        - Все активные подписки переводятся в статус Cancelled.
        - Баланс обнуляется (с созданием записи в истории платежей как Refund).

**Предусловия**:

- Проверка наличия активных подписок через Organization.HasActiveSubscriptions().

**Возможные ошибки**:

- `ActiveSubscriptionsException`: Невозможно удалить организацию с активными подписками (без флага force).
- `InsufficientPermissionsException`: Попытка удаления чужой организации.

**Выходные данные**:

- `deletionDate`: Дата удаления.
- `refundedAmount`: Сумма возврата (только для администратора при force).

---

## UpdateAutoTopUpSettings
**Назначение**: Настройка автопополнения баланса.

**Доступ**: Только владелец организации.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `isEnabled`: Флаг активации автопополнения.
- `topUpAmount`: Сумма пополнения (обязательна, если `isEnabled = true`).
- `paymentMethodId`: Идентификатор платежного метода (обязательный).

**Условия выполнения**:

- `topUpAmount > 0`.
- `paymentMethodId` должен принадлежать владельцу.
- `Threshold` рассчитывается автоматически как 10% от месячной суммы подписок (не передается явно).

**Предусловия**:

- Проверка платежного метода: PaymentMethodService.ValidateOwner(paymentMethodId, ownerId).
- Расчет месячной суммы подписок: BillingCalculator.CalculateMonthlyTotal(organizationId).

**Постусловия**:

- Обновление `AutoTopUpSettings` в агрегате `Organization`.
- При `isEnabled = true` проверка текущего баланса на предмет немедленного срабатывания автопополнения.

**Возможные ошибки**:

- `InvalidTopUpAmountException`: Сумма ≤ 0.
- `PaymentMethodNotFoundException`: Платежный метод не найден или не принадлежит владельцу.
- `NoActiveSubscriptionsException`: Невозможно рассчитать порог (нет подписок).

**Выходные данные**:

- `autoTopUpSettings`: Обновленные настройки.
- `threshold`: Рассчитанный порог срабатывания (например, 100 RUB).

---

## TopUpBalance
**Назначение**: Ручное пополнение баланса организации.

**Доступ**: Только владелец организации.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `amount`: Сумма пополнения (обязательная, положительное число).
- `paymentMethodId`: Идентификатор платежного метода (обязательный).

**Условия выполнения**:

- Сумма должна быть в валюте организации (проверяется через MoneyAmount.ValidateCurrency).
- Платежный метод должен принадлежать владельцу.
- Организация не должна быть в статусе Suspended.

**Предусловия**:

- Проверка платежного метода: PaymentMethodService.ValidateOwner(paymentMethodId, ownerId).
- Проверка валюты: amount.Currency == organization.Currency.

**Постусловия**:

- Создание платежа типа `TopUp`.
- Увеличение баланса через `Organization.AdjustBalance(+amount)`.

**Возможные ошибки**:

- `InvalidCurrencyException`: Валюта суммы не совпадает с валютой организации.
- `PaymentMethodNotFoundException`: Платежный метод не найден.
- `SuspendedOrganizationException`: Организация заблокирована.

**Выходные данные**:

- `newBalance`: Обновленный баланс.
- `transactionId`: Идентификатор транзакции пополнения.

---

## ManagePaymentMethods
**Назначение**: Управление платежными методами (добавление/удаление).

**Доступ**: Только владелец организации.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `action`: Действие (Add или Remove).
- `paymentMethodData` (для Add): Данные платежного метода (номер карты, токен и т.д.).
- `paymentMethodId` (для Remove): Идентификатор удаляемого метода.

**Условия выполнения**:

- `Для Add`:
    - Данные платежного метода должны быть валидны (проверка через платежный шлюз).
    - Нельзя добавить дублирующий метод (например, ту же карту).

- `Для Remove`:
    - Метод должен существовать и принадлежать владельцу.
    - Нельзя удалить метод, используемый в автопополнении.

**Предусловия**:

- Проверка через `PaymentGateway.ValidateMethod(paymentMethodData)`.

**Постусловия**:

- `Для Add`: Создание `PaymentMethod` в системе.
- `Для Remove`: Пометка метода как `Archived` (не удаляется физически).

**Возможные ошибки**:

- `DuplicatePaymentMethodException`: Платежный метод уже добавлен.
- `AutoTopUpMethodInUseException`: Нельзя удалить метод, привязанный к автопополнению.
- `InvalidPaymentMethodException`: Некорректные данные платежного метода.

**Выходные данные**:

- `paymentMethods`: Обновленный список платежных методов.
- `defaultMethodId`: Идентификатор метода по умолчанию.

---

## GetQuotaUsage
**Назначение**: Просмотр текущего использования квот.

**Доступ**:

- `Пользователь`: Только свои квоты.
- `Администратор`: Все квоты по organizationId.

**Входные параметры**:

- `organizationId`: Идентификатор организации.
- `resourceType` (опционально): Фильтр по типу ресурса (например, tokens).

**Выходные данные**:

- `quotaUsage`: Массив объектов с полями:
    - `resourceType`: Тип ресурса.
    - `used`: Использовано.
    - `limit`: Лимит.
    - `subscriptionId`: Идентификатор подписки.

**Возможные ошибки**:

- `ResourceTypeNotSupportedException`: Указан неподдерживаемый тип ресурса.
