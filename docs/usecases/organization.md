# OrganizationAppService

Управление организациями.

### CreateOrganization
**Назначение**: Создание новой организации с фиксированной валютой.
**Доступ**: Только пользователь (владелец).

**Предусловия**:
- Пользователь должен быть аутентифицирован и иметь подтвержденный аккаунт.
- Пользователь не имеет активных организаций (ограничение: 1 организация на владельца).

**Входные параметры**:
- `name`: Название организации (обязательный, строка, 3–100 символов).
- `currencyCode`: Код валюты (обязательный, например, RUB, USD; должен быть в списке поддерживаемых системой).

**Условия выполнения**:
- Валюта должна быть в списке SupportedCurrencies (проверяется через Currency.IsValidCode()).
- Название организации должно быть уникальным (проверяется через IOrganizationRepository.CheckNameUniqueness(name)).
- Владелец должен иметь подтвержденный аккаунт.

**Постусловия**:
- Создание агрегата Organization с:
  - Balance = 0.
  - AutoTopUpSettings = { IsEnabled: false, Threshold: 0, TopUpAmount: 0 }.
  - Status = Active.
  - PrimaryContactId = текущий пользователь.
- Привязка организации к владельцу (идентификатор пользователя).
- Создание записи в истории организации.

**Возможные ошибки**:
- `OrganizationLimitExceededException`: Владелец уже имеет активную организацию.
- `UnsupportedCurrencyException`: Указана невалидная валюта.
- `NameAlreadyExistsException`: Название занято.
- `InvalidNameException`: Некорректное название (длина или символы).

**Выходные данные**:
- `organizationId`: Уникальный идентификатор созданной организации.
- `name`: Название организации.
- `currency`: Валюта организации (например, RUB).
- `status`: Статус организации (должен быть Active).
- `createdAt`: Дата и время создания.

---

### GetOrganization
**Назначение**: Получение данных об организации.
**Доступ**:
- `Пользователь`: Только своя организация.
- `Администратор`: Любая организация по organizationId.

**Предусловия**:
- Для пользователя: organizationId должен принадлежать владельцу.
- Для администратора: организация должна существовать.

**Входные параметры**:
- `organizationId`: Идентификатор организации (обязательный).

**Условия выполнения**:
- Организация должна существовать.
- Пользователь должен иметь права на доступ к организации.

**Выходные данные**:
- `id`: Уникальный идентификатор.
- `name`: Название.
- `currency`: Валюта.
- `balance`: Текущий баланс (в валюте организации).
- `autoTopUpSettings`: Настройки автопополнения.
- `subscriptions`: Список активных подписок (только для владельца и администратора).
- `status`: Статус организации (Active, Suspended, Deleted).
- `createdAt`, `updatedAt`: Даты создания и последнего обновления.
- `primaryContactId`: Идентификатор владельца.

**Возможные ошибки**:
- `OrganizationNotFoundException`: Организация не найдена.
- `AccessDeniedException`: Попытка доступа к чужой организации.

---

### UpdateOrganization
**Назначение**: Обновление данных организации.
**Доступ**:
- `Пользователь`: Только название (name).
- `Администратор`: Все поля, кроме currency (валюта неизменна).

**Предусловия**:
- Организация должна существовать.
- Пользователь должен иметь права на редактирование организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `name` (опционально): Новое название.
- `status` (только для администратора): Новый статус (Suspended, Active).
- `primaryContactId` (только для администратора): Новый владелец.

**Условия выполнения**:
- Для пользователя: нельзя менять currency, balance, status.
- Для администратора:
  - При переводе в статус Suspended все активные подписки приостанавливаются.
  - Баланс можно изменить только через AdjustBalance (отдельный метод для админов).
  - Название должно быть уникальным (если обновляется).
  - Нельзя перевести организацию в статус Deleted напрямую (требуется DeleteOrganization).

**Постусловия**:
- Обновление указанных полей.
- Создание записи в истории изменений.
- При смене статуса на Suspended отправка уведомления владельцу.

**Возможные ошибки**:
- `InvalidStatusTransitionException`: Некорректный переход статуса.
- `CurrencyModificationException`: Попытка изменить валюту.
- `NameAlreadyExistsException`: Название занято.
- `InvalidNameException`: Некорректное название.

**Выходные данные**:
- `organizationId`: Идентификатор обновленной организации.
- `updatedFields`: Список обновленных полей (например, ["name", "status"]).
- `newStatus`: Новый статус (если был изменен).
- `updatedAt`: Время обновления.

---

### DeleteOrganization
**Назначение**: Удаление организации.
**Доступ**:
- `Пользователь`: Только своя организация, если нет активных подписок или долгов.
- `Администратор`: Принудительное удаление (все подписки отменяются, баланс обнуляется).

**Предусловия**:
- Организация должна существовать.
- Проверка наличия активных подписок через Organization.HasActiveSubscriptions().

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `force` (только для администратора): Флаг принудительного удаления.

**Условия выполнения**:
- Для пользователя:
  - Все подписки должны быть отменены (status = Cancelled).
  - Баланс = 0.
  - Нет необработанных платежей.
- Для администратора:
  - При force = true:
    - Все активные подписки переводятся в статус Cancelled с возвратом пропорциональной стоимости.
    - Баланс обнуляется (с созданием записи в истории платежей как Refund).
    - Все квоты сбрасываются.

**Постусловия**:
- Пометка организации как удаленной (физическое удаление происходит позже).
- Создание записей об отмене подписок и возврате средств.
- Уведомление владельца об удалении.

**Возможные ошибки**:
- `ActiveSubscriptionsException`: Невозможно удалить организацию с активными подписками (без флага force).
- `InsufficientPermissionsException`: Попытка удаления чужой организации.
- `NonZeroBalanceException`: Баланс не равен нулю (для пользователя).

**Выходные данные**:
- `organizationId`: Идентификатор удаленной организации.
- `deletionDate`: Дата удаления.
- `refundedAmount`: Сумма возврата (только для администратора при force).
- `cancelledSubscriptions`: Количество отмененных подписок.

---

### UpdateAutoTopUpSettings
**Назначение**: Настройка автопополнения баланса.
**Доступ**: Только владелец организации.

**Предусловия**:
- Организация должна существовать и принадлежать пользователю.
- Пользователь должен быть владельцем организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `isEnabled`: Флаг активации автопополнения.
- `topUpAmount`: Сумма пополнения (обязательна, если `isEnabled = true`).
- `paymentMethodId`: Идентификатор платежного метода (обязательный при `isEnabled = true`).

**Условия выполнения**:
- `topUpAmount > 0` (при `isEnabled = true`).
- `paymentMethodId` должен принадлежать владельцу и быть действительным.
- `Threshold` рассчитывается автоматически как 10% от месячной суммы подписок (не передается явно).
- Нельзя включить автопополнение без платежного метода.

**Постусловия**:
- Обновление `AutoTopUpSettings` в агрегате `Organization`.
- При `isEnabled = true` проверка текущего баланса на предмет немедленного срабатывания автопополнения.
- Создание записи в истории настроек.

**Возможные ошибки**:
- `InvalidTopUpAmountException`: Сумма ≤ 0.
- `PaymentMethodNotFoundException`: Платежный метод не найден или не принадлежит владельцу.
- `NoActiveSubscriptionsException`: Невозможно рассчитать порог (нет подписок).
- `AutoTopUpDisabledException`: Попытка установить параметры при отключенном автопополнении.

**Выходные данные**:
- `organizationId`: Идентификатор организации.
- `autoTopUpSettings`: Обновленные настройки.
- `threshold`: Рассчитанный порог срабатывания (например, 100 RUB).
- `isReadyForAutoTopUp`: Готово ли к немедленному срабатыванию (если баланс ниже порога).

---

### TopUpBalance
**Назначение**: Ручное пополнение баланса организации.
**Доступ**: Только владелец организации.

**Предусловия**:
- Организация должна существовать и принадлежать пользователю.
- Пользователь должен быть владельцем организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `amount`: Сумма пополнения (обязательная, положительное число).
- `paymentMethodId`: Идентификатор платежного метода (обязательный).
- `description` (опционально): Описание операции.

**Условия выполнения**:
- Сумма должна быть в валюте организации (проверяется через MoneyAmount.ValidateCurrency).
- Платежный метод должен принадлежать владельцу.
- Организация не должна быть в статусе Suspended.
- Сумма > 0.

**Постусловия**:
- Создание платежа типа `TopUp`.
- Увеличение баланса через `Organization.AdjustBalance(+amount)`.
- Создание записи в истории платежей.
- При достижении определенного порога отправка уведомления.

**Возможные ошибки**:
- `InvalidCurrencyException`: Валюта суммы не совпадает с валютой организации.
- `PaymentMethodNotFoundException`: Платежный метод не найден.
- `SuspendedOrganizationException`: Организация заблокирована.
- `InvalidAmountException`: Сумма ≤ 0.

**Выходные данные**:
- `organizationId`: Идентификатор организации.
- `newBalance`: Обновленный баланс.
- `transactionId`: Идентификатор транзакции пополнения.
- `status`: Статус операции (Success, Failed).

---

### ManagePaymentMethods
**Назначение**: Управление платежными методами (добавление/удаление).
**Доступ**: Только владелец организации.

**Предусловия**:
- Организация должна существовать и принадлежать пользователю.
- Пользователь должен быть владельцем организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `action`: Действие (Add или Remove).
- `paymentMethodData` (для Add): Данные платежного метода (номер карты, токен и т.д.).
- `paymentMethodId` (для Remove): Идентификатор удаляемого метода.
- `isDefault` (опционально): Сделать метод методом по умолчанию.

**Условия выполнения**:
- Для Add:
  - Данные платежного метода должны быть валидны (проверка через платежный шлюз).
  - Нельзя добавить дублирующий метод (например, ту же карту).
  - Минимум один метод должен существовать.
- Для Remove:
  - Метод должен существовать и принадлежать владельцу.
  - Нельзя удалить метод, используемый в автопополнении.
  - Нельзя удалить последний платежный метод.

**Постусловия**:
- Для Add: Создание `PaymentMethod` в системе и сохранение токенизированных данных.
- Для Remove: Пометка метода как `Archived` (не удаляется физически).
- При добавлении первого метода установка его как метода по умолчанию.

**Возможные ошибки**:
- `DuplicatePaymentMethodException`: Платежный метод уже добавлен.
- `AutoTopUpMethodInUseException`: Нельзя удалить метод, привязанный к автопополнению.
- `InvalidPaymentMethodException`: Некорректные данные платежного метода.
- `LastPaymentMethodException`: Нельзя удалить последний платежный метод.
- `PaymentMethodLimitExceededException`: Превышен лимит платежных методов.

**Выходные данные**:
- `organizationId`: Идентификатор организации.
- `paymentMethods`: Обновленный список платежных методов.
- `defaultMethodId`: Идентификатор метода по умолчанию.
- `actionResult`: Результат операции (Added, Removed, Updated).

---

### GetQuotaUsage
**Назначение**: Просмотр текущего использования квот.
**Доступ**:
- `Пользователь`: Только свои квоты.
- `Администратор`: Все квоты по organizationId.

**Предусловия**:
- Организация должна существовать.
- Пользователь должен иметь права на доступ к организации.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `resourceType` (опционально): Фильтр по типу ресурса (например, tokens).
- `includeHistorical` (опционально): Включить исторические данные (по умолчанию false).

**Условия выполнения**:
- Для пользователя: organizationId должен принадлежать владельцу.
- Для администратора: организация должна существовать.

**Выходные данные**:
- `organizationId`: Идентификатор организации.
- `quotaUsage`: Массив объектов с полями:
  - `resourceType`: Тип ресурса.
  - `used`: Использовано.
  - `limit`: Лимит.
  - `subscriptionId`: Идентификатор подписки.
  - `periodStart`, `periodEnd`: Период действия квоты.
  - `resetDate`: Дата сброса квоты (для периодических тарифов).
- `totalResources`: Общее количество ресурсов.

**Возможные ошибки**:
- `ResourceTypeNotSupportedException`: Указан неподдерживаемый тип ресурса.
- `OrganizationNotFoundException`: Организация не найдена.
- `AccessDeniedException`: Попытка доступа к чужой организации.