# SubscriptionAppService

Управление подписками.

### GetActiveSubscription
**Назначение**: Получение списка активных подписок.
**Доступ**:
- `Пользователь`: Только свои активные подписки.
- `Администратор`: Все активные подписки по `organizationId`.

**Предусловия**:
- Для пользователя: пользователь должен быть владельцем организации.
- Для администратора: организация должна существовать.

**Входные параметры**:
- `organizationId` (опционально для администратора): Фильтр по организации.
- `includeInactive` (опционально): Включить неактивные подписки (по умолчанию false).
- `resourceType` (опционально): Фильтр по типу ресурса.

**Условия выполнения**:
- Для пользователя без указания organizationId возвращаются подписки его организации.
- Возвращаются только активные подписки (если не указано includeInactive).

**Выходные данные**:
- `subscriptions`: Массив подписок с полями:
  - `id`: Уникальный идентификатор.
  - `tariffName`: Название тарифа.
  - `status`: Статус (Active, Pending, Suspended, Cancelled).
  - `billingCycle`: Тип списания (Hourly, Monthly, OneTime).
  - `nextBillingDate`: Дата следующего списания (для периодических тарифов).
  - `expirationDate`: Дата окончания (для OneTime тарифов).
  - `quotaUsage`: Текущее использование квот (например, `tokens_used: 500/1000`).
  - `currentPeriodStart`, `currentPeriodEnd`: Текущий расчетный период.
- `totalSubscriptions`: Общее количество подписок.

**Возможные ошибки**:
- `AccessDeniedException`: Попытка доступа к чужим подпискам.
- `OrganizationNotFoundException`: Организация не найдена.

---

### CreateSubscription
**Назначение**: Подключение тарифа к организации.
**Доступ**: Только владелец организации.

**Предусловия**:
- Организация должна существовать и быть активной.
- Пользователь должен быть владельцем организации.
- Тариф должен существовать и быть активным.

**Входные параметры**:
- `organizationId`: Идентификатор организации.
- `tariffId`: Идентификатор тарифа.
- `period` (опционально): Период оплаты (для гибких тарифов).
- `paymentMethodId` (опционально): Метод оплаты (если не указан, используется метод по умолчанию).

**Условия выполнения**:
- Валюта тарифа должна совпадать с валютой организации.
- Тариф должен быть активным (не архивным).
- Для тарифов с `BillingCycle = OneTime` проверка отсутствия активной подписки на этот тариф.
- Для тарифов с `BillingCycle = Monthly/Hourly` проверка отсутствия активной подписки на тариф той же категории.
- Баланс организации ≥ стоимости первоначального платежа (если требуется предоплата).

**Постусловия**:
- Создание `Subscription` со статусом `Pending`.
- Генерация платежа через `PaymentService.CreatePayment()`.
- Резервирование квот для нового тарифа.
- Отправка уведомления о создании подписки.

**Возможные ошибки**:
- `CurrencyMismatchException`: Валюта тарифа не совпадает с валютой организации.
- `TariffArchivedException`: Тариф находится в архиве.
- `SubscriptionLimitExceededException`: Превышено количество объектов (например, уже подключено 10 SSL-сертификатов).
- `ActiveSubscriptionExistsException`: Уже существует активная подписка на этот тариф.
- `InsufficientFundsException`: Недостаточно средств для первоначального платежа.

**Выходные данные**:
- `subscriptionId`: Идентификатор подписки.
- `requiredPaymentAmount`: Сумма для оплаты.
- `nextBillingDate`: Дата следующего списания (для периодических тарифов).
- `expirationDate`: Дата окончания (для OneTime тарифов).
- `status`: Текущий статус подписки (Pending).

---

### ConfirmSubscriptionPayment
**Назначение**: Подтверждение оплаты и активация подписки.
**Доступ**: Только владелец организации.

**Предусловия**:
- Подписка должна существовать и принадлежать организации пользователя.
- Пользователь должен быть владельцем организации.

**Входные параметры**:
- `subscriptionId`: Идентификатор подписки.
- `paymentId`: Идентификатор платежа.

**Условия выполнения**:
- Подписка должна быть в статусе `Pending`.
- Платеж должен быть в статусе `Completed`.
- Сумма платежа должна соответствовать цене тарифа.
- Платеж должен быть связан с этой подпиской.

**Постусловия**:
- Статус подписки меняется на `Active`.
- Для периодических тарифов списание средств с баланса.
- Инициализация квот: `CurrentQuotaUsage = 0`.
- Установка даты начала и окончания текущего периода.
- Отправка уведомления об активации подписки.

**Возможные ошибки**:
- `InvalidPaymentStatusException`: Платеж не подтвержден или не завершен.
- `SubscriptionAlreadyConfirmedException`: Подписка уже активна.
- `PaymentMismatchException`: Платеж не соответствует подписке.
- `SubscriptionNotFoundException`: Подписка не найдена.

**Выходные данные**:
- `subscriptionId`: Идентификатор подписки.
- `activationDate`: Дата активации.
- `currentPeriodEnd`: Дата окончания текущего периода.
- `quotaLimits`: Лимиты квот (например, `tokens_limit: 1000`).
- `status`: Новый статус (Active).

---

### CancelSubscription
**Назначение**: Отмена активной подписки с возвратом средств за неиспользованный период.
**Доступ**: Только владелец организации.

**Предусловия**:
- Подписка должна существовать и принадлежать организации пользователя.
- Пользователь должен быть владельцем организации.

**Входные параметры**:
- `subscriptionId`: Идентификатор подписки.
- `refundPolicy`: Политика возврата (`Full`, `Prorated`, `None`).
- `cancellationDate` (опционально): Дата отмены (по умолчанию текущая).

**Условия выполнения**:
- Подписка должна быть в статусе `Active`.
- Для `BillingCycle = OneTime` возврат невозможен (политика `None`).
- Для `Monthly/Hourly`:
  - `Full`: Возврат полной суммы (только в течение 24 часов после оплаты).
  - `Prorated`: Возврат пропорционально неиспользованному периоду.
- `cancellationDate` не может быть в будущем.

**Постусловия**:
- Статус подписки меняется на `Cancelled`.
- Создание платежа типа `Refund`.
- Обновление баланса: `Organization.AdjustBalance(+refundAmount)`.
- Блокировка использования ресурсов по подписке после даты отмены.
- Отправка уведомления об отмене подписки.

**Возможные ошибки**:
- `InvalidSubscriptionStatusException`: Подписка неактивна.
- `RefundPolicyNotSupportedException`: Неподдерживаемая политика возврата.
- `CancellationDateInvalidException`: Некорректная дата отмены.
- `SubscriptionNotFoundException`: Подписка не найдена.

**Выходные данные**:
- `subscriptionId`: Идентификатор подписки.
- `refundAmount`: Сумма возврата.
- `newBalance`: Обновленный баланс.
- `cancellationDate`: Дата отмены.
- `serviceAvailableUntil`: Дата, до которой доступны услуги.

---

### UpgradeSubscription
**Назначение**: Смена тарифа на более дорогой с немедленным списанием разницы.
**Доступ**: Только владелец организации.

**Предусловия**:
- Подписка должна существовать и принадлежать организации пользователя.
- Пользователь должен быть владельцем организации.
- Новый тариф должен существовать и быть активным.

**Входные параметры**:
- `subscriptionId`: Идентификатор текущей подписки.
- `newTariffId`: Идентификатор нового тарифа.
- `prorationType`: Тип перерасчета (`Immediate`, `NextBillingCycle`).
- `paymentMethodId` (опционально): Метод оплаты.

**Условия выполнения**:
- Новый тариф должен быть дороже текущего.
- Валюта нового тарифа должна совпадать с валютой организации.
- Для `prorationType = Immediate`:
  - Списывается разница между стоимостью остатка текущего периода и новым тарифом.
- Для `prorationType = NextBillingCycle`:
  - Изменение вступает в силу с даты следующего списания.
  - Немедленного списания нет.

**Постусловия**:
- Обновление `TariffId` в подписке.
- Для Immediate: списание разницы через `Organization.AdjustBalance(-proratedCost)`.
- Сброс квот для нового тарифа.
- Обновление даты следующего списания при необходимости.
- Создание записи об изменении тарифа.

**Возможные ошибки**:
- `DowngradeNotAllowedException`: Новый тариф дешевле (используйте `DowngradeSubscription`).
- `InsufficientFundsException`: Недостаточно средств для перерасчета.
- `CurrencyMismatchException`: Валюта нового тарифа не совпадает с валютой организации.
- `TariffArchivedException`: Новый тариф находится в архиве.

**Выходные данные**:
- `subscriptionId`: Идентификатор подписки.
- `proratedCost`: Сумма списания за перерасчет (для Immediate).
- `newQuotaLimits`: Обновленные лимиты квот.
- `nextBillingDate`: Обновленная дата следующего списания.
- `effectiveDate`: Дата применения нового тарифа.

---

### DowngradeSubscription
**Назначение**: Смена тарифа на более дешевый с эффектом с даты следующего списания.
**Доступ**: Только владелец организации.

**Предусловия**:
- Подписка должна существовать и принадлежать организации пользователя.
- Пользователь должен быть владельцем организации.
- Новый тариф должен существовать и быть активным.

**Входные параметры**:
- `subscriptionId`: Идентификатор текущей подписки.
- `newTariffId`: Идентификатор нового тарифа.

**Условия выполнения**:
- Новый тариф должен быть дешевле текущего.
- Изменение вступает в силу с `NextBillingDate`.
- Тарифы должны быть совместимы (одной категории).

**Постусловия**:
- Установка `PendingTariffId = newTariffId`.
- Обновление `NextBillingDate` (если требуется).
- Создание записи об изменении тарифа.
- Отправка уведомления о предстоящем понижении тарифа.

**Возможные ошибки**:
- `UpgradeRequiredException`: Новый тариф дороже (используйте `UpgradeSubscription`).
- `TariffIncompatibleException`: Тарифы несовместимы (разные категории).
- `TariffArchivedException`: Новый тариф находится в архиве.

**Выходные данные**:
- `subscriptionId`: Идентификатор подписки.
- `effectiveDate`: Дата применения нового тарифа (обычно NextBillingDate).
- `currentTariffId`: Текущий тариф.
- `pendingTariffId`: Новый тариф, который будет применен.

---

### ExtendSubscription
**Назначение**: Продление разовой подписки (например, SSL-сертификата).
**Доступ**: Только владелец организации.

**Предусловия**:
- Подписка должна существовать и принадлежать организации пользователя.
- Пользователь должен быть владельцем организации.
- Подписка должна быть OneTime тарифом.

**Входные параметры**:
- `subscriptionId`: Идентификатор подписки.
- `period`: Период продления (для OneTime тарифов).
- `paymentMethodId` (опционально): Метод оплаты.

**Условия выполнения**:
- Подписка должна быть в статусе `Completed` или `Expiring` (разовый тариф).
- Тариф должен поддерживать продление.
- Баланс организации ≥ стоимости продления.
- Период должен быть допустимым для тарифа.

**Постусловия**:
- Создание новой `Subscription` с тем же тарифом.
- Списание средств за новый период.
- Обновление даты окончания текущей подписки или создание новой.
- Отправка уведомления о продлении.

**Возможные ошибки**:
- `NonExtendableTariffException`: Тариф не поддерживает продление.
- `InvalidSubscriptionStatusException`: Подписка не в статусе, допускающем продление.
- `InsufficientFundsException`: Недостаточно средств для продления.
- `InvalidPeriodException`: Недопустимый период продления.

**Выходные данные**:
- `subscriptionId`: Идентификатор текущей или новой подписки.
- `newSubscriptionId` (опционально): Идентификатор новой подписки (если создана).
- `nextExpirationDate`: Новая дата окончания.
- `chargedAmount`: Сумма списания за продление.
- `status`: Текущий статус подписки.