# SubscriptionAppService

Управление подписками.

---

## GetActiveSubscription
**Назначение:** Получение списка активных подписок.

**Доступ:**

- `Пользователь`: Только свои активные подписки.
- `Администратор`: Все активные подписки по `organizationId`.

**Входные параметры:**

- `organizationId` (опционально для администратора): Фильтр по организации.

**Выходные данные:**

- `subscriptions`: Массив подписок с полями:
- `tariffName`: Название тарифа.
- `status`: Статус (Active, Pending, Suspended).
- `nextBillingDate`: Дата следующего списания.
- `quotaUsage`: Текущее использование квот (например, `tokens_used: 500/1000`).

**Возможные ошибки:**

- `AccessDeniedException`: Попытка доступа к чужим подпискам.

---

## CreateSubscription
**Назначение:** Подключение тарифа к организации.

**Доступ:** Только владелец организации.

**Входные параметры:**

- `organizationId`: Идентификатор организации.
- `tariffId`: Идентификатор тарифа.
- `period` (опционально): Период оплаты (для гибких тарифов).

**Условия выполнения:**

- Валюта тарифа должна совпадать с валютой организации.
- Тариф должен быть активным (не архивным).
- Для тарифов с `BillingCycle = OneTime` проверка отсутствия активной подписки на этот тариф.

**Предусловия:**

- Проверка цены тарифа в валюте организации: `TariffService.GetPriceByCurrency(tariffId, organization.Currency)`.
- Расчет суммы оплаты: `BillingCalculator.CalculateInitialAmount(tariffId, period)`.

**Постусловия:**

- Создание `Subscription` со статусом `Pending`.
- Генерация платежа через `PaymentService.CreatePayment()`.

**Возможные ошибки:**

- `CurrencyMismatchException`: Валюта тарифа не совпадает с валютой организации.
- `TariffArchivedException`: Тариф находится в архиве.
- `SubscriptionLimitExceededException`: Превышено количество объектов (например, уже подключено 10 SSL-сертификатов).

**Выходные данные:**

- `subscriptionId`: Идентификатор подписки.
- `requiredPaymentAmount`: Сумма для оплаты.
- `nextBillingDate`: Дата следующего списания (для периодических тарифов).

---

## ConfirmSubscriptionPayment
**Назначение:** Подтверждение оплаты и активация подписки.

**Доступ:** Только владелец организации.

**Входные параметры:**

- `subscriptionId`: Идентификатор подписки.
- `paymentId`: Идентификатор платежа.

**Условия выполнения:**

- Подписка должна быть в статусе `Pending`.
- Платеж должен быть в статусе `Completed`.
- Сумма платежа должна соответствовать цене тарифа.

**Предусловия:**

- Проверка через `PaymentService.ValidatePayment(paymentId, subscriptionId)`.

**Постусловия:**

- Статус подписки меняется на `Active`.
- Списание средств с баланса (если это не `OneTime` тариф).
- Инициализация квот: `CurrentQuotaUsage = 0`.

**Возможные ошибки:**

- `InvalidPaymentStatusException`: Платеж не подтвержден.
- `SubscriptionAlreadyConfirmedException`: Подписка уже активна.

**Выходные данные:**

- `activationDate`: Дата активации.
- `quotaLimits`: Лимиты квот (например, `tokens_limit: 1000`).

---

## CancelSubscription
**Назначение:** Отмена активной подписки с возвратом средств за неиспользованный период.

**Доступ:** Только владелец организации.

**Входные параметры:**

- `subscriptionId`: Идентификатор подписки.
- `refundPolicy`: Политика возврата (`Full`, `Prorated`, `None`).

**Условия выполнения:**

- Подписка должна быть в статусе `Active`.
- Для `BillingCycle = OneTime` возврат невозможен (политика `None`).
- Для `Monthly/Hourly`:
    - `Full`: Возврат полной суммы (только в течение 24 часов).
    - `Prorated`: Возврат пропорционально неиспользованному периоду.

**Предусловия:**

- Расчет суммы возврата через `BillingCalculator.CalculateRefund(subscriptionId, refundPolicy)`.

**Постусловия:**

- Статус подписки меняется на `Cancelled`.
- Создание платежа типа `Refund`.
- Обновление баланса: `Organization.AdjustBalance(+refundAmount)`.

**Возможные ошибки:**

- `InvalidSubscriptionStatusException`: Подписка неактивна.
- `RefundPolicyNotSupportedException`: Неподдерживаемая политика возврата.

**Выходные данные:**

- `refundAmount`: Сумма возврата.
- `newBalance`: Обновленный баланс.

---

## UpgradeSubscription
**Назначение:** Смена тарифа на более дорогой с немедленным списанием разницы.

**Доступ:** Только владелец организации.

**Входные параметры:**

- `subscriptionId`: Идентификатор текущей подписки.
- `newTariffId`: Идентификатор нового тарифа.
- `prorationType`: Тип перерасчета (`Immediate`, `NextBillingCycle`).

**Условия выполнения:**

- Новый тариф должен быть дороже текущего.
- Валюта нового тарифа должна совпадать с валютой организации.
- Для `prorationType = Immediate`:
    - Списывается разница между стоимостью остатка текущего периода и новым тарифом.

**Предусловия:**

- Проверка через `BillingCalculator.CalculateProratedCost(subscriptionId, newTariffId)`.
- Проверка баланса: `organization.Balance >= proratedCost`.

**Постусловия:**

- Обновление `TariffId` в подписке.
- Списание разницы через `Organization.AdjustBalance(-proratedCost)`.
- Сброс квот для нового тарифа.

**Возможные ошибки:**

- `DowngradeNotAllowedException`: Новый тариф дешевле (используйте `DowngradeSubscription`).
- `InsufficientFundsException`: Недостаточно средств для перерасчета.

**Выходные данные:**

- `proratedCost`: Сумма списания за перерасчет.
- `newQuotaLimits`: Обновленные лимиты квот.

---

## DowngradeSubscription
**Назначение:** Смена тарифа на более дешевый с эффектом с даты следующего списания.

**Доступ:** Только владелец организации.

**Входные параметры:**

- `subscriptionId`: Идентификатор текущей подписки.
- `newTariffId`: Идентификатор нового тарифа.

**Условия выполнения:**

- Новый тариф должен быть дешевле текущего.
- Изменение вступает в силу с `NextBillingDate`.

**Постусловия:**

- Установка `PendingTariffId = newTariffId`.
- Обновление `NextBillingDate` (если требуется).

**Возможные ошибки:**

- `UpgradeRequiredException`: Новый тариф дороже (используйте `UpgradeSubscription`).

**Выходные данные:**

- `effectiveDate`: Дата применения нового тарифа (обычно NextBillingDate).

---

## ExtendSubscription
**Назначение:** Продление разовой подписки (например, SSL-сертификата).

**Доступ:** Только владелец организации.

**Входные параметры:**

- `subscriptionId`: Идентификатор подписки.
- `period`: Период продления (для OneTime тарифов).

**Условия выполнения:**

- Подписка должна быть в статусе `Completed` (разовый тариф).
- Тариф должен поддерживать продление.

**Постусловия:**

- Создание новой `Subscription` с тем же тарифом.
- Списание средств за новый период.

**Возможные ошибки:**

- `NonExtendableTariffException`: Тариф не поддерживает продление.

**Выходные данные:**

- `newSubscriptionId`: Идентификатор новой подписки.
- `nextExpirationDate`: Новая дата окончания.
