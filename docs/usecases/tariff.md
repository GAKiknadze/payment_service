# TariffAppService

Управление тарифами.

**Доступ** только для администратора.

---

## GetTariffsList
**Назначение:** Получение списка активных тарифов.

**Входные параметры:**

- `includeArchived` (опционально): Включить архивные тарифы (по умолчанию false).

**Выходные данные:**

- `tariffs`: Массив тарифов с полями:
    - `id`, `name`, `description`.
    - `prices`: Цены в разных валютах (например, [{ currency: "RUB", amount: 100 }]).
    - `quotas`: Лимиты ресурсов (например, [{ resource: "tokens", limit: 1000 }]).
    - `billingCycle`: Тип списания (Hourly, Monthly, OneTime).

---

## GetTariff
**Назначение:** Получение деталей тарифа.

**Входные параметры:**

- `tariffId`: Идентификатор тарифа.

**Выходные данные:**

- Все поля тарифа, включая историю изменений (для архивных версий).

---

## UpdateTariff
**Назначение:** Обновление тарифа.

**Входные параметры:**

- `tariffId`: Идентификатор тарифа.
- `name`, description (опционально): Новые данные.
- `prices` (опционально): Новые цены (добавление/удаление).
- `quotas` (опционально): Новые лимиты.
- `billingCycle` (опционально): Новый тип списания.

**Условия выполнения:**

- Нельзя изменить `billingCycle` для тарифов с активными подписками.
- При обновлении цен/квот новые значения применяются только к новым подпискам.

**Предусловия:**

- Проверка конфликтов: `TariffService.ValidateChanges(tariffId, newValues)`.

**Возможные ошибки:**

- `ActiveSubscriptionsConflictException`: Нельзя изменить критические параметры при наличии активных подписок.
- `InvalidBillingCycleException`: Неподдерживаемый тип списания.

**Выходные данные:**

- `updatedTariff`: Объект обновленного тарифа.
- `affectedSubscriptions`: Количество подписок, которые перейдут на новую версию тарифа.

---

## ArchiveTariff
**Назначение:** Архивирование тарифа (запрет подключения новых подписок).

**Входные параметры:**

- `tariffId`: Идентификатор тарифа.
- `reason`: Причина архивации (обязательная, строка).

**Условия выполнения:**

- Тариф должен быть активным.
- Нельзя архивировать тарифы с активными подписками (требуется сначала отключить все подписки).

**Предусловия:**

- Проверка через `TariffService.HasActiveSubscriptions(tariffId)`.

**Возможные ошибки:**

- `ActiveSubscriptionsException`: Тариф используется в активных подписках.
- `TariffAlreadyArchivedException`: Тариф уже в архиве.

**Выходные данные:**

- `archivedDate`: Дата архивации.
- `deprecationWarning`: Предупреждение для пользователей (например, "Тариф будет недоступен с 01.01.2024").

---

## CreateTariff
**Назначение:** Создание нового тарифа администратором.

**Доступ**: Только администратор.

**Входные параметры:**

- `name`, `description`: Название и описание.
- `billingCycle`: Тип списания (`Hourly`, `Monthly`, `OneTime`).
- `prices`: Цены в разных валютах (массив { `currency`, `amount` }).
- `quotas`: Лимиты ресурсов (массив { `resourceType`, `limit` }).

**Условия выполнения:**

- Для `Hourly/Monthly` должен быть указан `prices`.
- Для `OneTime` квоты могут быть фиксированными (например, ssl_certificates: 1).

**Предусловия:**

- Проверка через `TariffValidator.Validate(billingCycle, prices, quotas)`.

**Постусловия**:

- Создание агрегата `Tariff` со статусом `Active`.
- Генерация уникального `tariffId`.

**Возможные ошибки:**

- `InvalidBillingCycleException`: Несовместимые параметры (например, `Hourly` с `OneTime` квотами).
- `MissingPricesException`: Не указаны цены для периодических тарифов.

**Выходные данные:**

- `tariffId`: Идентификатор созданного тарифа.
- `createdDate`: Дата создания.

---

## AddPriceToTariff
**Назначение:** Добавление цены в новой валюте к существующему тарифу.

**Доступ**: Только администратор.

**Входные параметры:**

- `tariffId`: Идентификатор тарифа.
- `currency`: Код валюты (например, EUR).
- `amount`: Сумма.

**Условия выполнения:**

- Валюта не должна существовать в тарифе.
- Тариф должен быть активным (не архивным).

**Постусловия**:

- Добавление объекта `Price` в коллекцию тарифа.

**Возможные ошибки:**

- `CurrencyAlreadyExistsException`: Цена в этой валюте уже добавлена.
- `ArchivedTariffException`: Тариф находится в архиве.

**Выходные данные:**

- `priceId`: Идентификатор новой цены.

---

## RemovePriceFromTariff
**Назначение:** Удаление цены в определенной валюте.

**Доступ**: Только администратор.

**Входные параметры:**

- `tariffId`: Идентификатор тарифа.
- `currency`: Код валюты.

**Условия выполнения:**

- Цена должна существовать в тарифе.
- Нельзя удалить последнюю цену (должна остаться хотя бы одна валюта).

**Постусловия**:

- Удаление объекта `Price` из коллекции тарифа.

**Возможные ошибки:**

- `LastPriceRemovalException`: Нельзя удалить единственную цену.

**Выходные данные:**

- `remainingCurrencies`: Список оставшихся валют.
