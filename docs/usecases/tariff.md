# TariffAppService

Управление тарифами.

Доступ только для администратора.

### GetTariffsList
**Назначение**: Получение списка тарифов с фильтрацией.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.

**Входные параметры**:
- `includeArchived` (опционально): Включить архивные тарифы (по умолчанию false).
- `billingCycle` (опционально): Фильтр по типу списания (Hourly, Monthly, OneTime).
- `pageSize` (опционально): Количество записей на странице (по умолчанию 20).
- `pageNumber` (опционально): Номер страницы (по умолчанию 1).
- `searchTerm` (опционально): Поисковый запрос по названию.

**Условия выполнения**:
- По умолчанию возвращаются только активные тарифы.
- Пагинация применяется при наличии большого количества тарифов.

**Выходные данные**:
- `tariffs`: Массив тарифов с полями:
  - `id`, `name`, `description`
  - `status`: Active или Archived
  - `prices`: Цены в разных валютах (например, [{ currency: "RUB", amount: 100, id: "price_123" }])
  - `quotas`: Лимиты ресурсов (например, [{ resource: "tokens", limit: 1000, unit: "count" }])
  - `billingCycle`: Тип списания (Hourly, Monthly, OneTime)
  - `isExtendable`: Поддерживает ли продление (для OneTime)
  - `createdAt`, `updatedAt`: Даты создания и обновления
- `totalItems`: Общее количество тарифов
- `currentPage`, `totalPages`: Информация о пагинации

**Возможные ошибки**:
- `AccessDeniedException`: Попытка доступа без прав администратора.

---

### GetTariff
**Назначение**: Получение деталей тарифа, включая историю изменений.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Тариф должен существовать.

**Входные параметры**:
- `tariffId`: Идентификатор тарифа.
- `includeHistory` (опционально): Включить историю изменений (по умолчанию true).

**Условия выполнения**:
- Тариф должен существовать в системе.

**Выходные данные**:
- `id`: Идентификатор тарифа.
- `name`, `description`: Название и описание.
- `status`: Статус (Active, Archived).
- `prices`: Цены в разных валютах.
- `quotas`: Лимиты ресурсов.
- `billingCycle`: Тип списания.
- `isExtendable`: Поддерживает ли продление (для OneTime).
- `createdAt`, `updatedAt`: Даты создания и последнего обновления.
- `archivedAt` (опционально): Дата архивации.
- `history` (опционально): История изменений тарифа.
- `activeSubscriptionsCount`: Количество активных подписок на этот тариф.

**Возможные ошибки**:
- `TariffNotFoundException`: Тариф не найден.

---

### UpdateTariff
**Назначение**: Обновление тарифа с управлением версиями.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Тариф должен существовать и быть активным.

**Входные параметры**:
- `tariffId`: Идентификатор тарифа.
- `name`, `description` (опционально): Новые данные.
- `prices` (опционально): Новые цены (добавление/удаление/обновление).
- `quotas` (опционально): Новые лимиты.
- `billingCycle` (опционально): Новый тип списания.
- `isExtendable` (опционально): Поддержка продления (для OneTime).

**Условия выполнения**:
- Нельзя изменить `billingCycle` для тарифов с активными подписками.
- При обновлении цен/квот новые значения применяются только к новым подпискам.
- Изменения критических параметров требуют подтверждения при наличии активных подписок.
- Для OneTime тарифов можно изменить isExtendable.

**Постусловия**:
- Создание новой версии тарифа.
- Обновление метаданных тарифа.
- При изменении критических параметров отправка уведомления подписчикам.
- Создание записи в истории изменений тарифа.

**Возможные ошибки**:
- `ActiveSubscriptionsConflictException`: Нельзя изменить критические параметры при наличии активных подписок.
- `InvalidBillingCycleException`: Неподдерживаемый тип списания.
- `TariffNotFoundException`: Тариф не найден.
- `ArchivedTariffException`: Попытка обновить архивный тариф.
- `InvalidPriceException`: Некорректные данные цены.

**Выходные данные**:
- `updatedTariff`: Объект обновленного тарифа.
- `version`: Новая версия тарифа.
- `affectedSubscriptions`: Количество подписок, которые перейдут на новую версию тарифа.
- `requiresNotification`: Требуется ли уведомление существующих подписчиков.

---

### ArchiveTariff
**Назначение**: Архивирование тарифа (запрет подключения новых подписок).
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Тариф должен существовать и быть активным.
- Тариф не должен иметь активных подписок.

**Входные параметры**:
- `tariffId`: Идентификатор тарифа.
- `reason`: Причина архивации (обязательная, строка).
- `notifyUsers` (опционально): Отправить уведомление пользователям (по умолчанию true).

**Условия выполнения**:
- Тариф должен быть активным.
- Нельзя архивировать тарифы с активными подписками (требуется сначала отключить все подписки).
- Причина архивации должна быть заполнена.

**Постусловия**:
- Изменение статуса тарифа на Archived.
- Установка даты архивации.
- При notifyUsers=true отправка уведомления всем, у кого есть подписки на этот тариф.
- Блокировка возможности создания новых подписок на этот тариф.

**Возможные ошибки**:
- `ActiveSubscriptionsException`: Тариф используется в активных подписках.
- `TariffAlreadyArchivedException`: Тариф уже в архиве.
- `TariffNotFoundException`: Тариф не найден.
- `InvalidReasonException`: Причина архивации не указана или слишком короткая.

**Выходные данные**:
- `tariffId`: Идентификатор тарифа.
- `archivedDate`: Дата архивации.
- `deprecationWarning`: Предупреждение для пользователей (например, "Тариф будет недоступен с 01.01.2024").
- `usersNotified`: Количество уведомленных пользователей.

---

### CreateTariff
**Назначение**: Создание нового тарифа администратором.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.

**Входные параметры**:
- `name`, `description`: Название и описание.
- `billingCycle`: Тип списания (`Hourly`, `Monthly`, `OneTime`).
- `prices`: Цены в разных валютах (массив { `currency`, `amount` }).
- `quotas`: Лимиты ресурсов (массив { `resourceType`, `limit`, `unit` }).
- `isExtendable` (опционально): Поддержка продления (только для OneTime, по умолчанию false).

**Условия выполнения**:
- Для `Hourly/Monthly` должен быть указан `prices`.
- Для `OneTime` квоты могут быть фиксированными (например, ssl_certificates: 1).
- Название тарифа должно быть уникальным.
- Для OneTime тарифов isExtendable может быть true.

**Постусловия**:
- Создание агрегата `Tariff` со статусом `Active`.
- Генерация уникального `tariffId`.
- Создание первой версии тарифа.
- Отправка уведомления о новом тарифе (если настроено).

**Возможные ошибки**:
- `InvalidBillingCycleException`: Несовместимые параметры (например, `Hourly` с `OneTime` квотами).
- `MissingPricesException`: Не указаны цены для периодических тарифов.
- `NameAlreadyExistsException`: Тариф с таким названием уже существует.
- `InvalidQuotaException`: Некорректные данные квот.
- `InvalidPriceException`: Некорректные данные цен.

**Выходные данные**:
- `tariffId`: Идентификатор созданного тарифа.
- `createdDate`: Дата создания.
- `version`: Начальная версия тарифа (обычно 1.0).
- `status`: Статус тарифа (Active).

---

### AddPriceToTariff
**Назначение**: Добавление цены в новой валюте к существующему тарифу.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Тариф должен существовать и быть активным.

**Входные параметры**:
- `tariffId`: Идентификатор тарифа.
- `currency`: Код валюты (например, EUR).
- `amount`: Сумма.
- `isDefault` (опционально): Сделать эту валюту валютой по умолчанию.

**Условия выполнения**:
- Валюта не должна существовать в тарифе.
- Тариф должен быть активным (не архивным).
- Сумма должна быть положительной.
- Валюта должна быть поддерживаемой системой.

**Постусловия**:
- Добавление объекта `Price` в коллекцию тарифа.
- При isDefault=true установка этой валюты как валюты по умолчанию.
- Создание записи в истории изменений тарифа.

**Возможные ошибки**:
- `CurrencyAlreadyExistsException`: Цена в этой валюте уже добавлена.
- `ArchivedTariffException`: Тариф находится в архиве.
- `InvalidCurrencyException`: Неподдерживаемая валюта.
- `InvalidAmountException`: Сумма ≤ 0.
- `TariffNotFoundException`: Тариф не найден.

**Выходные данные**:
- `tariffId`: Идентификатор тарифа.
- `priceId`: Идентификатор новой цены.
- `updatedPrices`: Обновленный список цен.
- `newDefaultCurrency` (опционально): Новая валюта по умолчанию.

---

### RemovePriceFromTariff
**Назначение**: Удаление цены в определенной валюте.
**Доступ**: Только администратор.

**Предусловия**:
- Пользователь должен иметь права администратора.
- Тариф должен существовать и быть активным.

**Входные параметры**:
- `tariffId`: Идентификатор тарифа.
- `currency`: Код валюты.

**Условия выполнения**:
- Цена должна существовать в тарифе.
- Нельзя удалить последнюю цену (должна остаться хотя бы одна валюта).
- Валюта не должна быть валютой по умолчанию (если только не удаляется последняя валюта).

**Постусловия**:
- Удаление объекта `Price` из коллекции тарифа.
- Если удаляется валюта по умолчанию, установка новой валюты по умолчанию.
- Создание записи в истории изменений тарифа.

**Возможные ошибки**:
- `PriceNotFoundException`: Цена в указанной валюте не найдена.
- `LastPriceRemovalException`: Нельзя удалить единственную цену.
- `DefaultCurrencyRemovalException`: Нельзя удалить валюту по умолчанию без указания новой.
- `TariffNotFoundException`: Тариф не найден.
- `ArchivedTariffException`: Тариф находится в архиве.

**Выходные данные**:
- `tariffId`: Идентификатор тарифа.
- `removedCurrency`: Удаленная валюта.
- `remainingCurrencies`: Список оставшихся валют.
- `newDefaultCurrency` (опционально): Новая валюта по умолчанию.