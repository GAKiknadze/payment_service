# Billing (домен)

Этот домен отвечает за обработку платежей, списаний и управление балансом.

## Агрегаты

### Payment

*Отдельная финансовая транзакция в системе.*

**Содержит:**
- `id` Уникальный идентификатор платежа
- `amount` Сумма платежа
- `currency` Валюта платежа
- `type` Тип платежа (`Subscription`, `TopUp`, `Refund`, `ManualCharge`)
- `status` Статус платежа (`Completed`, `Failed`, `Pending`)
- `timestamp` Дата и время проведения платежа
- `subscriptionId` Идентификатор подписки (для платежей типа Subscription)
- `organizationId` Идентификатор организации
- `relatedEntityId` Идентификатор связанной сущности

## События

### PaymentCreated
*Создан новый платеж*

**Когда происходит:**
- При создании любой финансовой транзакции (подписка, пополнение, ручное списание)

**Данные события:**
- `paymentID` Уникальный идентификатор платежа
- `organizationID` Идентификатор организации
- `amount` Сумма платежа (MoneyAmount)
- `type` Тип платежа (Subscription, TopUp, Refund, ManualCharge)
- `timestamp` Время создания
- `relatedEntityID` Связанная сущность (например, subscriptionID)

**Используется для:**
- Отправки уведомления пользователю о новом платеже
- Обновления статистики в реальном времени
- Логирования финансовых операций
- Интеграции с внешними системами аналитики

### PaymentCompleted
*Платеж успешно завершен*

**Когда происходит:**
- После успешной обработки платежа платежным шлюзом

**Данные события:**
- `paymentID` Идентификатор платежа
- `organizationID` Идентификатор организации
- `amount` Сумма платежа
- `gatewayTransactionID` Идентификатор транзакции платежного шлюза
- `completionTime` Время завершения

**Используется для:**
- Обновления баланса организации
- Активации подписки (если платеж был за подписку)
- Обновления использования квот
- Отправки подтверждающего письма

### PaymentFailed
*Платеж завершился неудачей*

**Когда происходит:**
- При неудачной обработке платежа платежным шлюзом
- После исчерпания лимита попыток оплаты

**Данные события:**
- `paymentID` Идентификатор платежа
- `organizationID` Идентификатор организации
- `amount` Сумма платежа
- `failureReason` Причина неудачи
- `retryCount` Количество попыток
- `isFinal` Является ли окончательной неудачей

**Используется для:**
- Приостановки подписки при недостатке средств
- Запуска процесса автопополнения
- Отправки уведомления о проблеме с платежом
- Логирования проблемных платежей для анализа

### BalanceUpdated
*Баланс организации изменен*

**Когда происходит:**
- При любом изменении баланса (пополнение, списание, возврат)

**Данные события:**
- `organizationID` Идентификатор организации
- `oldBalance` Предыдущий баланс (MoneyAmount)
- `newBalance` Новый баланс (MoneyAmount)
- `delta` Изменение баланса (MoneyAmount)
- `paymentID` Идентификатор связанного платежа
- `updateReason` Причина изменения (TopUp, Subscription, Refund)

**Используется для:**
- Проверки необходимости автопополнения
- Обновления статуса организации (при нулевом балансе)
- Отправки уведомлений о критическом уровне баланса
- Формирования финансовой отчетности

### AutoTopUpTriggered
*Сработало автопополнение баланса*

**Когда происходит:**
- При достижении балансом порогового значения
- При ручном запуске автопополнения администратором

**Данные события:**
- `organizationID` Идентификатор организации
- `currentBalance` Текущий баланс перед пополнением
- `topUpAmount` Сумма пополнения
- `threshold` Пороговое значение
- `paymentMethodID` Использованный платежный метод
- `isForced` Было ли принудительным запуском

**Используется для:**
- Создания платежа на пополнение
- Отправки уведомления об автопополнении
- Логирования автоматических финансовых операций
- Анализа эффективности автопополнения

## Репозитории

### IPaymentRepository

#### CreatePayment(payment *Payment) (string, error)
Создает новый платеж в системе.

**Входные параметры:**
- `payment` Указатель на агрегат Payment

**Выходные параметры:**
- `string` Идентификатор созданного платежа
- `error` Ошибка создания платежа (например, InvalidPaymentDataError)

#### GetPaymentByID(paymentID string) (*Payment, error)
Получает платеж по его идентификатору.

**Входные параметры:**
- `paymentID` Идентификатор платежа

**Выходные параметры:**
- `*Payment` Указатель на агрегат Payment
- `error` Ошибка получения (например, PaymentNotFoundError)

#### GetPaymentHistory(filter PaymentHistoryFilter, page int, pageSize int) ([]Payment, int, error)
Получает историю платежей с фильтрацией и пагинацией.

**Входные параметры:**
- `filter` Value Object PaymentHistoryFilter
- `page` Номер страницы (начиная с 1)
- `pageSize` Количество записей на странице

**Выходные параметры:**
- `[]Payment` Список платежей
- `int` Общее количество записей (для пагинации)
- `error` Ошибка запроса (например, InvalidDateRangeError)

#### UpdatePaymentStatus(paymentID string, status PaymentStatus, gatewayData map[string]interface{}) error
Обновляет статус платежа и сохраняет данные платежного шлюза.

**Входные параметры:**
- `paymentID` Идентификатор платежа
- `status` Новый статус платежа
- `gatewayData` Дополнительные данные от платежного шлюза

**Выходные параметры:**
- `error` Ошибка обновления (например, InvalidPaymentStatusError)

#### IncrementRetryCount(paymentID string) (int, error)
Увеличивает счетчик попыток для платежа и возвращает текущее значение.

**Входные параметры:**
- `paymentID` Идентификатор платежа

**Выходные параметры:**
- `int` Текущее количество попыток
- `error` Ошибка обновления (например, PaymentNotFoundError)

#### GetFailedPaymentsBefore(date time.Time) ([]Payment, error)
Получает список неудачных платежей до указанной даты.

**Входные параметры:**
- `date` Дата для фильтрации

**Выходные параметры:**
- `[]Payment` Список неудачных платежей
- `error` Ошибка запроса
