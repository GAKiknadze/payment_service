# Organization (домен)

Этот домен отвечает за управление данными об организациях и их настройках.

## Агрегаты

### Organization

*Контрактный партнер системы с собственными настройками и балансом.*

**Содержит:**
- `id` Уникальный идентификатор организации
- `name` Название организации
- `currency` Валюта организации
- `balance` Текущий баланс (в валюте организации)
- `autoTopUpSettings` Настройки автопополнения
- `status` Статус организации (`Active`, `Suspended`, `Deleted`)
- `primaryContactId` Идентификатор владельца (пользователя)
- `createdAt` Дата создания
- `updatedAt` Дата последнего обновления
- `paymentMethods` Список платежных методов
- `subscriptions` Список активных подписок

## События

### OrganizationCreated
*Создана новая организация*

**Когда происходит:**
- После успешного создания организации пользователем

**Данные события:**
- `organizationID` Идентификатор организации
- `ownerID` Идентификатор владельца
- `name` Название организации
- `currency` Валюта организации
- `creationTime` Время создания

**Используется для:**
- Отправки приветственного письма
- Создания записей по умолчанию (например, шаблонных квот)
- Интеграции с CRM системой
- Начисления бонусов за регистрацию

### OrganizationStatusChanged
*Изменен статус организации*

**Когда происходит:**
- При переводе организации в статус Suspended или Active
- При удалении организации

**Данные события:**
- `organizationID` Идентификатор организации
- `oldStatus` Предыдущий статус
- `newStatus` Новый статус
- `changedBy` Кем изменен (пользователь или система)
- `changeReason` Причина изменения статуса

**Используется для:**
- Приостановки или возобновления всех активных подписок
- Блокировки/разблокировки доступа к системе
- Отправки уведомления владельцу об изменении статуса
- Аудита изменений статуса организаций

### AutoTopUpSettingsUpdated
*Обновлены настройки автопополнения*

**Когда происходит:**
- При изменении настроек автопополнения владельцем организации

**Данные события:**
- `organizationID` Идентификатор организации
- `oldSettings` Предыдущие настройки
- `newSettings` Новые настройки
- `updatedBy` Кем обновлено

**Используется для:**
- Проверки возможности немедленного срабатывания автопополнения
- Отправки подтверждения об изменении настроек
- Логирования изменений финансовых настроек
- Валидации новых настроек с текущим состоянием

### PaymentMethodAdded
*Добавлен новый платежный метод*

**Когда происходит:**
- При добавлении платежного метода владельцем организации

**Данные события:**
- `organizationID` Идентификатор организации
- `paymentMethodID` Идентификатор платежного метода
- `paymentMethodType` Тип метода (Card, PayPal и т.д.)
- `displayData` Данные для отображения (например, последние 4 цифры карты)
- `isDefault` Сделан ли методом по умолчанию

**Используется для:**
- Установки нового метода по умолчанию
- Отправки уведомления о добавлении платежного метода
- Проверки возможности использования метода для автопополнения
- Интеграции с платежными системами для токенизации данных

### PaymentMethodRemoved
*Удален платежный метод*

**Когда происходит:**
- При удалении платежного метода владельцем организации

**Данные события:**
- `organizationID` Идентификатор организации
- `paymentMethodID` Идентификатор удаленного метода
- `paymentMethodType` Тип метода
- `wasDefault` Был ли методом по умолчанию
- `isInUse` Использовался ли метод в автопополнении

**Используется для:**
- Обновления метода по умолчанию
- Проверки необходимости обновления настроек автопополнения
- Отправки уведомления об удалении платежного метода
- Очистки данных в платежных системах

## Репозитории

### IOrganizationRepository

#### Create(organization *Organization) error
Создает новую организацию в системе.

**Входные параметры:**
- `organization` Указатель на агрегат Organization

**Выходные параметры:**
- `error` Ошибка создания (например, OrganizationLimitExceededError)

#### GetByID(organizationID string) (*Organization, error)
Получает организацию по идентификатору.

**Входные параметры:**
- `organizationID` Идентификатор организации

**Выходные параметры:**
- `*Organization` Указатель на агрегат Organization
- `error` Ошибка получения (например, OrganizationNotFoundError)

#### GetByOwnerID(ownerID string) (*Organization, error)
Получает организацию по идентификатору владельца.

**Входные параметры:**
- `ownerID` Идентификатор пользователя-владельца

**Выходные параметры:**
- `*Organization` Указатель на агрегат Organization
- `error` Ошибка получения (например, OrganizationNotFoundError)

#### Update(organization *Organization) error
Обновляет данные организации.

**Входные параметры:**
- `organization` Указатель на агрегат Organization с обновленными данными

**Выходные параметры:**
- `error` Ошибка обновления (например, InvalidOrganizationStatusError)

#### AdjustBalance(organizationID string, amount MoneyAmount) (MoneyAmount, error)
Изменяет баланс организации на указанную сумму.

**Входные параметры:**
- `organizationID` Идентификатор организации
- `amount` Value Object MoneyAmount с суммой изменения

**Выходные параметры:**
- `MoneyAmount` Новый баланс организации
- `error` Ошибка изменения (например, InsufficientFundsError)

#### GetOrganizations(filter OrganizationFilter, page int, pageSize int) ([]Organization, int, error)
Получает список организаций с фильтрацией и пагинацией.

**Входные параметры:**
- `filter` Фильтр для поиска организаций
- `page` Номер страницы
- `pageSize` Размер страницы

**Выходные параметры:**
- `[]Organization` Список организаций
- `int` Общее количество записей
- `error` Ошибка запроса
