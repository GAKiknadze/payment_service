# Subscription (домен)

Этот домен отвечает за жизненный цикл подписок и их взаимодействие с тарифами.

## Агрегаты

### Subscription

*Подписка организации на тарифный план.*

**Содержит:**
- `id` Уникальный идентификатор подписки
- `tariffId` Идентификатор тарифа
- `organizationId` Идентификатор организации
- `status` Статус подписки (`Active`, `Pending`, `Suspended`, `Cancelled`)
- `nextBillingDate` Дата следующего списания
- `expirationDate` Дата окончания (для OneTime тарифов)
- `currentPeriodStart` Начало текущего расчетного периода
- `currentPeriodEnd` Конец текущего расчетного периода
- `pendingTariffId` Идентификатор будущего тарифа (при понижении)
- `createdAt` Дата создания подписки
- `updatedAt` Дата последнего обновления

## События

### SubscriptionCreated
*Создана новая подписка*

**Когда происходит:**
- После успешного создания подписки пользователем

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `tariffID` Идентификатор тарифа
- `status` Начальный статус (обычно Pending)
- `creationTime` Время создания

**Используется для:**
- Создания платежа для оплаты подписки
- Инициализации квот для новой подписки
- Отправки уведомления о создании подписки
- Запланирования следующего списания

### SubscriptionActivated
*Подписка активирована*

**Когда происходит:**
- После успешной оплаты и подтверждения платежа

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `tariffID` Идентификатор тарифа
- `activationTime` Время активации
- `nextBillingDate` Дата следующего списания
- `currentPeriodStart` Начало текущего периода
- `currentPeriodEnd` Конец текущего периода

**Используется для:**
- Сброса квот к начальным значениям
- Обновления доступа к ресурсам
- Отправки приветственного письма по подписке
- Интеграции с системой мониторинга использования

### SubscriptionCancelled
*Подписка отменена*

**Когда происходит:**
- После успешной отмены подписки пользователем

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `cancellationTime` Время отмены
- `serviceAvailableUntil` Дата окончания услуг
- `refundAmount` Сумма возврата
- `refundPolicy` Политика возврата

**Используется для:**
- Блокировки доступа к ресурсам после даты окончания
- Обновления баланса организации
- Отправки подтверждения об отмене
- Логирования причин отмены подписок

### SubscriptionUpgraded
*Подписка обновлена на более дорогой тариф*

**Когда происходит:**
- После успешного обновления подписки на более дорогой тариф

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `oldTariffID` Предыдущий тариф
- `newTariffID` Новый тариф
- `proratedCost` Сумма перерасчета
- `effectiveImmediately` Применено немедленно
- `newQuotaLimits` Новые лимиты квот

**Используется для:**
- Сброса квот к новым значениям
- Обновления даты следующего списания
- Отправки уведомления об обновлении тарифа
- Анализа трансформации подписок

### SubscriptionDowngraded
*Подписка понижена на более дешевый тариф*

**Когда происходит:**
- После успешного понижения подписки на более дешевый тариф

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `currentTariffID` Текущий тариф
- `pendingTariffID` Новый тариф
- `effectiveDate` Дата применения нового тарифа
- `oldQuotaLimits` Старые лимиты квот
- `newQuotaLimits` Новые лимиты квот

**Используется для:**
- Отправки уведомления о предстоящем понижении
- Планирования изменения квот в будущем
- Подготовки информации для пользователя о новых ограничениях
- Мониторинга тенденций понижения тарифов

### SubscriptionExtended
*Подписка продлена*

**Когда происходит:**
- После успешного продления разовой подписки

**Данные события:**
- `subscriptionID` Идентификатор текущей подписки
- `newSubscriptionID` Идентификатор новой подписки (если создана)
- `organizationID` Идентификатор организации
- `extendedPeriod` Продленный период
- `nextExpirationDate` Новая дата окончания
- `chargedAmount` Сумма списания за продление

**Используется для:**
- Обновления даты окончания текущей подписки
- Создания новой подписки при необходимости
- Отправки уведомления о продлении
- Обновления использования квот

### BillingScheduled
*Запланировано списание средств*

**Когда происходит:**
- При установке даты следующего списания для подписки
- При изменении периода списания

**Данные события:**
- `subscriptionID` Идентификатор подписки
- `organizationID` Идентификатор организации
- `scheduledDate` Запланированная дата списания
- `billingCycle` Тип периодичности
- `amount` Ожидаемая сумма списания

**Используется для:**
- Добавления задачи в систему планирования
- Отправки напоминания о предстоящем списании
- Прогнозирования доходов
- Мониторинга загрузки системы в период списаний

## Репозитории

### ISubscriptionRepository

#### Create(subscription *Subscription) (string, error)
Создает новую подписку в системе.

**Входные параметры:**
- `subscription` Указатель на агрегат Subscription

**Выходные параметры:**
- `string` Идентификатор созданной подписки
- `error` Ошибка создания (например, ActiveSubscriptionExistsError)

#### GetByID(subscriptionID string) (*Subscription, error)
Получает подписку по идентификатору.

**Входные параметры:**
- `subscriptionID` Идентификатор подписки

**Выходные параметры:**
- `*Subscription` Указатель на агрегат Subscription
- `error` Ошибка получения (например, SubscriptionNotFoundError)

#### GetByOrganizationID(organizationID string, includeInactive bool) ([]Subscription, error)
Получает все подписки организации.

**Входные параметры:**
- `organizationID` Идентификатор организации
- `includeInactive` Включать неактивные подписки

**Выходные параметры:**
- `[]Subscription` Список подписок
- `error` Ошибка запроса

#### GetActiveSubscriptionsByTariff(tariffID string) ([]Subscription, error)
Получает активные подписки на указанный тариф.

**Входные параметры:**
- `tariffID` Идентификатор тарифа

**Выходные параметры:**
- `[]Subscription` Список активных подписок
- `error` Ошибка запроса

#### Update(subscription *Subscription) error
Обновляет данные подписки.

**Входные параметры:**
- `subscription` Указатель на агрегат Subscription с обновленными данными

**Выходные параметры:**
- `error` Ошибка обновления (например, InvalidSubscriptionStatusError)

#### Cancel(subscriptionID string, refundAmount MoneyAmount) error
Отменяет подписку и регистрирует сумму возврата.

**Входные параметры:**
- `subscriptionID` Идентификатор подписки
- `refundAmount` Value Object MoneyAmount с суммой возврата

**Выходные параметры:**
- `error` Ошибка отмены (например, InvalidSubscriptionStatusError)

#### GetSubscriptionsDueForBilling(currentDate time.Time) ([]Subscription, error)
Получает подписки, требующие списания средств на указанную дату.

**Входные параметры:**
- `currentDate` Текущая дата для проверки

**Выходные параметры:**
- `[]Subscription` Список подписок, готовых к списанию
- `error` Ошибка запроса
